035436258415205047ea362a044d8e5d
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.Event = void 0;
const mongoose_1 = __importStar(require("mongoose"));
const EventSchema = new mongoose_1.Schema({
    hub_id: {
        type: String,
        required: true,
        index: true
    },
    event_type: {
        type: String,
        enum: ['impression', 'click'],
        required: true,
        default: 'click',
        index: true
    },
    ip: {
        type: String,
        required: true
    },
    country: {
        type: String,
        default: 'unknown'
    },
    lat: {
        type: Number,
        default: 0
    },
    lon: {
        type: Number,
        default: 0
    },
    user_agent: {
        type: String,
        default: ''
    },
    device_type: {
        type: String,
        default: 'unknown'
    },
    timestamp: {
        type: Date,
        default: Date.now,
        // Note: Don't add index: true here - TTL index below creates the index
    },
    chosen_variant_id: {
        type: String,
        required: true,
        index: true
    },
    processed: {
        type: Boolean,
        default: false
    },
});
// Compound indexes for efficient querying
EventSchema.index({ hub_id: 1, timestamp: -1 });
EventSchema.index({ hub_id: 1, event_type: 1, timestamp: -1 });
EventSchema.index({ chosen_variant_id: 1, event_type: 1, timestamp: -1 });
EventSchema.index({ processed: 1, timestamp: 1 });
// TTL index to auto-delete old events after 90 days (optional)
EventSchema.index({ timestamp: 1 }, { expireAfterSeconds: 90 * 24 * 60 * 60 });
exports.Event = mongoose_1.default.model('Event', EventSchema);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dyb3Zlci5oZWVyL0RvY3VtZW50cy9HaXRIdWIvQWR2aXRpeWFfSC9zcmMvbW9kZWxzL0V2ZW50LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHFEQUFzRDtBQXVCdEQsTUFBTSxXQUFXLEdBQUcsSUFBSSxpQkFBTSxDQUFTO0lBQ25DLE1BQU0sRUFBRTtRQUNKLElBQUksRUFBRSxNQUFNO1FBQ1osUUFBUSxFQUFFLElBQUk7UUFDZCxLQUFLLEVBQUUsSUFBSTtLQUNkO0lBQ0QsVUFBVSxFQUFFO1FBQ1IsSUFBSSxFQUFFLE1BQU07UUFDWixJQUFJLEVBQUUsQ0FBQyxZQUFZLEVBQUUsT0FBTyxDQUFDO1FBQzdCLFFBQVEsRUFBRSxJQUFJO1FBQ2QsT0FBTyxFQUFFLE9BQU87UUFDaEIsS0FBSyxFQUFFLElBQUk7S0FDZDtJQUNELEVBQUUsRUFBRTtRQUNBLElBQUksRUFBRSxNQUFNO1FBQ1osUUFBUSxFQUFFLElBQUk7S0FDakI7SUFDRCxPQUFPLEVBQUU7UUFDTCxJQUFJLEVBQUUsTUFBTTtRQUNaLE9BQU8sRUFBRSxTQUFTO0tBQ3JCO0lBQ0QsR0FBRyxFQUFFO1FBQ0QsSUFBSSxFQUFFLE1BQU07UUFDWixPQUFPLEVBQUUsQ0FBQztLQUNiO0lBQ0QsR0FBRyxFQUFFO1FBQ0QsSUFBSSxFQUFFLE1BQU07UUFDWixPQUFPLEVBQUUsQ0FBQztLQUNiO0lBQ0QsVUFBVSxFQUFFO1FBQ1IsSUFBSSxFQUFFLE1BQU07UUFDWixPQUFPLEVBQUUsRUFBRTtLQUNkO0lBQ0QsV0FBVyxFQUFFO1FBQ1QsSUFBSSxFQUFFLE1BQU07UUFDWixPQUFPLEVBQUUsU0FBUztLQUNyQjtJQUNELFNBQVMsRUFBRTtRQUNQLElBQUksRUFBRSxJQUFJO1FBQ1YsT0FBTyxFQUFFLElBQUksQ0FBQyxHQUFHO1FBQ2pCLHVFQUF1RTtLQUMxRTtJQUNELGlCQUFpQixFQUFFO1FBQ2YsSUFBSSxFQUFFLE1BQU07UUFDWixRQUFRLEVBQUUsSUFBSTtRQUNkLEtBQUssRUFBRSxJQUFJO0tBQ2Q7SUFDRCxTQUFTLEVBQUU7UUFDUCxJQUFJLEVBQUUsT0FBTztRQUNiLE9BQU8sRUFBRSxLQUFLO0tBQ2pCO0NBQ0osQ0FBQyxDQUFDO0FBRUgsMENBQTBDO0FBQzFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDaEQsV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQy9ELFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxpQkFBaUIsRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzFFLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBRWxELCtEQUErRDtBQUMvRCxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsa0JBQWtCLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUVsRSxRQUFBLEtBQUssR0FBRyxrQkFBUSxDQUFDLEtBQUssQ0FBUyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2dyb3Zlci5oZWVyL0RvY3VtZW50cy9HaXRIdWIvQWR2aXRpeWFfSC9zcmMvbW9kZWxzL0V2ZW50LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBtb25nb29zZSwgeyBTY2hlbWEsIERvY3VtZW50IH0gZnJvbSAnbW9uZ29vc2UnO1xuXG4vKipcbiAqIEV2ZW50IHR5cGVzIGZvciBhbmFseXRpY3NcbiAqIC0gaW1wcmVzc2lvbjogTGluayByZXNvbHV0aW9uIGNvbXBsZXRlZCAodmFyaWFudCBzZWxlY3RlZClcbiAqIC0gY2xpY2s6IFJlZGlyZWN0IGV4ZWN1dGVkICh1c2VyIGZvbGxvd2VkIHRoZSBsaW5rKVxuICovXG5leHBvcnQgdHlwZSBFdmVudFR5cGUgPSAnaW1wcmVzc2lvbicgfCAnY2xpY2snO1xuXG5leHBvcnQgaW50ZXJmYWNlIElFdmVudCBleHRlbmRzIERvY3VtZW50IHtcbiAgICBodWJfaWQ6IHN0cmluZztcbiAgICBldmVudF90eXBlOiBFdmVudFR5cGU7XG4gICAgaXA6IHN0cmluZztcbiAgICBjb3VudHJ5OiBzdHJpbmc7XG4gICAgbGF0OiBudW1iZXI7XG4gICAgbG9uOiBudW1iZXI7XG4gICAgdXNlcl9hZ2VudDogc3RyaW5nO1xuICAgIGRldmljZV90eXBlOiBzdHJpbmc7XG4gICAgdGltZXN0YW1wOiBEYXRlO1xuICAgIGNob3Nlbl92YXJpYW50X2lkOiBzdHJpbmc7XG4gICAgcHJvY2Vzc2VkOiBib29sZWFuO1xufVxuXG5jb25zdCBFdmVudFNjaGVtYSA9IG5ldyBTY2hlbWE8SUV2ZW50Pih7XG4gICAgaHViX2lkOiB7XG4gICAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgIGluZGV4OiB0cnVlXG4gICAgfSxcbiAgICBldmVudF90eXBlOiB7XG4gICAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgICAgZW51bTogWydpbXByZXNzaW9uJywgJ2NsaWNrJ10sXG4gICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICBkZWZhdWx0OiAnY2xpY2snLFxuICAgICAgICBpbmRleDogdHJ1ZVxuICAgIH0sXG4gICAgaXA6IHtcbiAgICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgICByZXF1aXJlZDogdHJ1ZVxuICAgIH0sXG4gICAgY291bnRyeToge1xuICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgIGRlZmF1bHQ6ICd1bmtub3duJ1xuICAgIH0sXG4gICAgbGF0OiB7XG4gICAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgICAgZGVmYXVsdDogMFxuICAgIH0sXG4gICAgbG9uOiB7XG4gICAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgICAgZGVmYXVsdDogMFxuICAgIH0sXG4gICAgdXNlcl9hZ2VudDoge1xuICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgIGRlZmF1bHQ6ICcnXG4gICAgfSxcbiAgICBkZXZpY2VfdHlwZToge1xuICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgIGRlZmF1bHQ6ICd1bmtub3duJ1xuICAgIH0sXG4gICAgdGltZXN0YW1wOiB7XG4gICAgICAgIHR5cGU6IERhdGUsXG4gICAgICAgIGRlZmF1bHQ6IERhdGUubm93LFxuICAgICAgICAvLyBOb3RlOiBEb24ndCBhZGQgaW5kZXg6IHRydWUgaGVyZSAtIFRUTCBpbmRleCBiZWxvdyBjcmVhdGVzIHRoZSBpbmRleFxuICAgIH0sXG4gICAgY2hvc2VuX3ZhcmlhbnRfaWQ6IHtcbiAgICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgaW5kZXg6IHRydWVcbiAgICB9LFxuICAgIHByb2Nlc3NlZDoge1xuICAgICAgICB0eXBlOiBCb29sZWFuLFxuICAgICAgICBkZWZhdWx0OiBmYWxzZVxuICAgIH0sXG59KTtcblxuLy8gQ29tcG91bmQgaW5kZXhlcyBmb3IgZWZmaWNpZW50IHF1ZXJ5aW5nXG5FdmVudFNjaGVtYS5pbmRleCh7IGh1Yl9pZDogMSwgdGltZXN0YW1wOiAtMSB9KTtcbkV2ZW50U2NoZW1hLmluZGV4KHsgaHViX2lkOiAxLCBldmVudF90eXBlOiAxLCB0aW1lc3RhbXA6IC0xIH0pO1xuRXZlbnRTY2hlbWEuaW5kZXgoeyBjaG9zZW5fdmFyaWFudF9pZDogMSwgZXZlbnRfdHlwZTogMSwgdGltZXN0YW1wOiAtMSB9KTtcbkV2ZW50U2NoZW1hLmluZGV4KHsgcHJvY2Vzc2VkOiAxLCB0aW1lc3RhbXA6IDEgfSk7XG5cbi8vIFRUTCBpbmRleCB0byBhdXRvLWRlbGV0ZSBvbGQgZXZlbnRzIGFmdGVyIDkwIGRheXMgKG9wdGlvbmFsKVxuRXZlbnRTY2hlbWEuaW5kZXgoeyB0aW1lc3RhbXA6IDEgfSwgeyBleHBpcmVBZnRlclNlY29uZHM6IDkwICogMjQgKiA2MCAqIDYwIH0pO1xuXG5leHBvcnQgY29uc3QgRXZlbnQgPSBtb25nb29zZS5tb2RlbDxJRXZlbnQ+KCdFdmVudCcsIEV2ZW50U2NoZW1hKTtcbiJdLCJ2ZXJzaW9uIjozfQ==