{"file":"/Users/grover.heer/Documents/GitHub/Advitiya_H/src/__tests__/config/testDatabase.ts","mappings":"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","names":[],"sources":["/Users/grover.heer/Documents/GitHub/Advitiya_H/src/__tests__/config/testDatabase.ts"],"sourcesContent":["import mongoose from 'mongoose';\nimport { MongoMemoryServer } from 'mongodb-memory-server';\n\n// Import all models to ensure they're registered\nimport { User } from '../../models/User';\nimport { LinkHub } from '../../models/LinkHub';\nimport { Variant } from '../../models/Variant';\nimport { VariantStats } from '../../models/VariantStats';\nimport { Event } from '../../models/Event';\nimport { RuleTree } from '../../models/RuleTree';\n\nlet mongoServer: MongoMemoryServer | null = null;\nlet isInitialized = false;\nlet usingExternalDb = false;\n\n/**\n * Test Database Setup\n * Uses in-memory MongoDB for complete isolation\n * Falls back to external test database if MongoMemoryServer fails (e.g., EPERM on macOS)\n * Uses a single connection for all tests to avoid index conflicts\n */\nexport async function setupTestDatabase(): Promise<string> {\n    // If already connected, just ensure indexes and return\n    if (isInitialized && mongoose.connection.readyState === 1) {\n        return mongoose.connection.host || '';\n    }\n\n    // Close any existing connection\n    if (mongoose.connection.readyState !== 0) {\n        await mongoose.connection.close();\n    }\n\n    let uri: string;\n\n    // Try to create in-memory MongoDB server, fallback to external if it fails\n    try {\n        if (!mongoServer) {\n            mongoServer = await MongoMemoryServer.create();\n        }\n        uri = mongoServer.getUri();\n        console.log('✓ Using in-memory MongoDB');\n    } catch (error: any) {\n        // Fallback to external test database\n        console.warn('⚠ MongoMemoryServer failed, using external test database');\n        console.warn(`  Error: ${error.message}`);\n\n        uri = process.env.MONGODB_URI || 'mongodb://localhost:27017/smart-link-hub-test';\n        usingExternalDb = true;\n\n        // Ensure we're using test database, not production\n        if (!uri.includes('test')) {\n            uri = uri.replace(/\\/([^/?]+)(\\?|$)/, '/smart-link-hub-test$2');\n        }\n        console.log(`✓ Using external MongoDB: ${uri}`);\n    }\n\n    await mongoose.connect(uri);\n\n    // CRITICAL: Synchronize all indexes explicitly (foreground mode)\n    // Only do this once per server instance\n    if (!isInitialized) {\n        await syncAllIndexes();\n        await verifyIndexes();\n        isInitialized = true;\n    }\n\n    console.log('✓ Test database connected');\n\n    return uri;\n}\n\n/**\n * Synchronize all model indexes in foreground mode\n * Blocks until all indexes are confirmed created\n */\nasync function syncAllIndexes(): Promise<void> {\n    const models = [User, LinkHub, Variant, VariantStats, Event, RuleTree];\n\n    for (const model of models) {\n        try {\n            // First drop all existing indexes (except _id)\n            try {\n                await model.collection.dropIndexes();\n            } catch {\n                // Collection may not exist yet, ignore\n            }\n\n            // Then create fresh indexes\n            await model.createIndexes();\n        } catch (error) {\n            console.error(`Failed to sync indexes for ${model.modelName}:`, error);\n            throw error;\n        }\n    }\n\n    console.log('✓ All indexes synchronized');\n}\n\n/**\n * Verify that expected unique indexes exist\n * Fails immediately if any expected index is missing\n */\nasync function verifyIndexes(): Promise<void> {\n    const errors: string[] = [];\n\n    // Check User indexes\n    const userIndexes = await User.collection.indexes();\n    if (!userIndexes.some(i => i.key.email && i.unique)) {\n        errors.push('User.email unique index missing');\n    }\n    if (!userIndexes.some(i => i.key.user_id && i.unique)) {\n        errors.push('User.user_id unique index missing');\n    }\n\n    // Check LinkHub indexes\n    const hubIndexes = await LinkHub.collection.indexes();\n    if (!hubIndexes.some(i => i.key.hub_id && i.unique)) {\n        errors.push('LinkHub.hub_id unique index missing');\n    }\n    if (!hubIndexes.some(i => i.key.slug && i.unique)) {\n        errors.push('LinkHub.slug unique index missing');\n    }\n\n    // Check VariantStats indexes\n    const statsIndexes = await VariantStats.collection.indexes();\n    if (!statsIndexes.some(i => i.key.variant_id && i.unique)) {\n        errors.push('VariantStats.variant_id unique index missing');\n    }\n\n    if (errors.length > 0) {\n        console.error('❌ Index verification failed:');\n        errors.forEach(e => console.error(`   - ${e}`));\n        throw new Error(`Index verification failed: ${errors.join(', ')}`);\n    }\n\n    console.log('✓ All indexes verified');\n}\n\n/**\n * Cleanup test database - call only at very end of all tests\n */\nexport async function cleanupTestDatabase(): Promise<void> {\n    // Don't actually close - let Jest handle final cleanup\n    // Just clear collections\n    await clearCollections();\n    console.log('✓ Test database cleaned up');\n}\n\n/**\n * Final cleanup - call only once at end of all test suites\n */\nexport async function finalCleanup(): Promise<void> {\n    if (mongoose.connection.readyState !== 0) {\n        // Only drop database if using in-memory server (safe to drop)\n        // For external databases, we just clear collections to preserve structure\n        if (!usingExternalDb) {\n            await mongoose.connection.dropDatabase();\n        } else {\n            await clearCollections();\n        }\n        await mongoose.connection.close();\n    }\n    if (mongoServer) {\n        await mongoServer.stop();\n        mongoServer = null;\n    }\n    isInitialized = false;\n    usingExternalDb = false;\n}\n\n/**\n * Clear all collections (preserves indexes)\n */\nexport async function clearCollections(): Promise<void> {\n    const collections = mongoose.connection.collections;\n    for (const key in collections) {\n        await collections[key].deleteMany({});\n    }\n}\n\n/**\n * Get connection status\n */\nexport function isConnected(): boolean {\n    return mongoose.connection.readyState === 1;\n}\n"],"version":3}