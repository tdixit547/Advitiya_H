{"file":"/Users/grover.heer/Documents/GitHub/Advitiya_H/src/__tests__/VariantResolver.test.ts","mappings":"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","names":[],"sources":["/Users/grover.heer/Documents/GitHub/Advitiya_H/src/__tests__/VariantResolver.test.ts"],"sourcesContent":["import { VariantResolver } from '../services/VariantResolver';\nimport { IVariant } from '../models/Variant';\nimport { IVariantStats } from '../models/VariantStats';\n\n// Mock mongoose models\njest.mock('../models/Variant', () => ({\n    Variant: {\n        find: jest.fn(),\n        findOne: jest.fn(),\n    },\n}));\n\njest.mock('../models/VariantStats', () => ({\n    VariantStats: {\n        find: jest.fn(),\n    },\n}));\n\nimport { Variant } from '../models/Variant';\nimport { VariantStats } from '../models/VariantStats';\n\ndescribe('VariantResolver', () => {\n    let resolver: VariantResolver;\n\n    beforeEach(() => {\n        resolver = new VariantResolver();\n        jest.clearAllMocks();\n    });\n\n    describe('resolveVariant', () => {\n        it('should return null for empty variant list', async () => {\n            const result = await resolver.resolveVariant([], 'hub_001');\n            expect(result).toBeNull();\n        });\n\n        it('should return variant directly if only one option', async () => {\n            const mockVariant = {\n                variant_id: 'var_1',\n                hub_id: 'hub_001',\n                target_url: 'https://example.com',\n                priority: 10,\n                weight: 1,\n                enabled: true,\n            } as IVariant;\n\n            (Variant.find as jest.Mock).mockResolvedValue([mockVariant]);\n\n            const result = await resolver.resolveVariant(['var_1'], 'hub_001');\n            expect(result).toEqual(mockVariant);\n        });\n\n        it('should select variant with highest score', async () => {\n            const variants = [\n                { variant_id: 'var_1', hub_id: 'hub_001', target_url: 'url1', priority: 5, weight: 1 },\n                { variant_id: 'var_2', hub_id: 'hub_001', target_url: 'url2', priority: 5, weight: 1 },\n            ] as IVariant[];\n\n            const stats = [\n                { variant_id: 'var_1', hub_id: 'hub_001', score: 0.5 },\n                { variant_id: 'var_2', hub_id: 'hub_001', score: 0.8 }, // Higher score\n            ] as IVariantStats[];\n\n            (Variant.find as jest.Mock).mockResolvedValue(variants);\n            (VariantStats.find as jest.Mock).mockResolvedValue(stats);\n\n            const result = await resolver.resolveVariant(['var_1', 'var_2'], 'hub_001');\n            expect(result?.variant_id).toBe('var_2');\n        });\n\n        it('should break ties using priority', async () => {\n            const variants = [\n                { variant_id: 'var_1', hub_id: 'hub_001', target_url: 'url1', priority: 5, weight: 1 },\n                { variant_id: 'var_2', hub_id: 'hub_001', target_url: 'url2', priority: 10, weight: 1 }, // Higher priority\n            ] as IVariant[];\n\n            const stats = [\n                { variant_id: 'var_1', hub_id: 'hub_001', score: 0.5 },\n                { variant_id: 'var_2', hub_id: 'hub_001', score: 0.5 }, // Same score\n            ] as IVariantStats[];\n\n            (Variant.find as jest.Mock).mockResolvedValue(variants);\n            (VariantStats.find as jest.Mock).mockResolvedValue(stats);\n\n            const result = await resolver.resolveVariant(['var_1', 'var_2'], 'hub_001');\n            expect(result?.variant_id).toBe('var_2');\n        });\n    });\n\n    describe('weightedRandom', () => {\n        it('should select from variants based on weight', () => {\n            const variants = [\n                { variant_id: 'var_1', weight: 1 },\n                { variant_id: 'var_2', weight: 9 }, // Much higher weight\n            ] as IVariant[];\n\n            // Run multiple times to test distribution\n            const counts: Record<string, number> = { var_1: 0, var_2: 0 };\n            const iterations = 1000;\n\n            for (let i = 0; i < iterations; i++) {\n                const result = resolver.weightedRandom(variants);\n                counts[result.variant_id]++;\n            }\n\n            // var_2 should be selected ~90% of the time\n            expect(counts.var_2).toBeGreaterThan(counts.var_1 * 5);\n        });\n\n        it('should handle zero weights', () => {\n            const variants = [\n                { variant_id: 'var_1', weight: 0 },\n                { variant_id: 'var_2', weight: 0 },\n            ] as IVariant[];\n\n            // Should still return a variant (random selection)\n            const result = resolver.weightedRandom(variants);\n            expect(['var_1', 'var_2']).toContain(result.variant_id);\n        });\n    });\n});\n"],"version":3}