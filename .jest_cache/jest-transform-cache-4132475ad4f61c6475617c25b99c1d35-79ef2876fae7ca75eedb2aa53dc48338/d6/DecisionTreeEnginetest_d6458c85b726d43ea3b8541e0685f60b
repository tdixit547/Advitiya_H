360c38e0817c57e004188d4f76b7dc36
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const DecisionTreeEngine_1 = require("../services/DecisionTreeEngine");
describe('DecisionTreeEngine', () => {
    let engine;
    beforeEach(() => {
        engine = new DecisionTreeEngine_1.DecisionTreeEngine();
    });
    describe('parseDevice', () => {
        it('should identify mobile devices', () => {
            const mobileUA = 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15';
            const result = engine.parseDevice(mobileUA);
            expect(result.type).toBe('mobile');
        });
        it('should identify desktop devices', () => {
            const desktopUA = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/91.0';
            const result = engine.parseDevice(desktopUA);
            expect(result.type).toBe('desktop');
        });
        it('should identify tablet devices', () => {
            const tabletUA = 'Mozilla/5.0 (iPad; CPU OS 14_0 like Mac OS X) AppleWebKit/605.1.15';
            const result = engine.parseDevice(tabletUA);
            expect(result.type).toBe('tablet');
        });
    });
    describe('traverse', () => {
        const sampleTree = {
            type: 'device',
            device_branches: {
                mobile: {
                    type: 'location',
                    country_branches: {
                        US: {
                            type: 'leaf',
                            variant_ids: ['var_us_mobile'],
                        },
                        IN: {
                            type: 'leaf',
                            variant_ids: ['var_in_mobile'],
                        },
                    },
                    location_default_node: {
                        type: 'leaf',
                        variant_ids: ['var_global_mobile'],
                    },
                },
                desktop: {
                    type: 'location',
                    country_branches: {
                        US: {
                            type: 'leaf',
                            variant_ids: ['var_us_desktop'],
                        },
                    },
                    location_default_node: {
                        type: 'leaf',
                        variant_ids: ['var_global_desktop'],
                    },
                },
                default: {
                    type: 'leaf',
                    variant_ids: ['var_other'],
                },
            },
        };
        it('should resolve mobile + US correctly', () => {
            const context = {
                userAgent: 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)',
                country: 'US',
                lat: 0,
                lon: 0,
                timestamp: new Date(),
            };
            const result = engine.traverse(context, sampleTree);
            expect(result).toEqual(['var_us_mobile']);
        });
        it('should resolve mobile + IN correctly', () => {
            const context = {
                userAgent: 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)',
                country: 'IN',
                lat: 0,
                lon: 0,
                timestamp: new Date(),
            };
            const result = engine.traverse(context, sampleTree);
            expect(result).toEqual(['var_in_mobile']);
        });
        it('should resolve desktop + US correctly', () => {
            const context = {
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/91.0',
                country: 'US',
                lat: 0,
                lon: 0,
                timestamp: new Date(),
            };
            const result = engine.traverse(context, sampleTree);
            expect(result).toEqual(['var_us_desktop']);
        });
        it('should fall back to global for unknown country', () => {
            const context = {
                userAgent: 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)',
                country: 'FR',
                lat: 0,
                lon: 0,
                timestamp: new Date(),
            };
            const result = engine.traverse(context, sampleTree);
            expect(result).toEqual(['var_global_mobile']);
        });
        it('should use default device branch for unknown devices', () => {
            const context = {
                userAgent: 'SomeBot/1.0',
                country: 'US',
                lat: 0,
                lon: 0,
                timestamp: new Date(),
            };
            const result = engine.traverse(context, sampleTree);
            expect(result).toEqual(['var_other']);
        });
    });
    describe('time window evaluation', () => {
        const timeTree = {
            type: 'time',
            time_windows: [
                {
                    branch_id: 'business_hours',
                    recurring: {
                        days: [1, 2, 3, 4, 5], // Mon-Fri
                        start_time: '09:00',
                        end_time: '17:00',
                        timezone: 'America/New_York',
                    },
                    next_node: {
                        type: 'leaf',
                        variant_ids: ['var_business'],
                    },
                },
            ],
            time_default_node: {
                type: 'leaf',
                variant_ids: ['var_afterhours'],
            },
        };
        it('should match business hours on weekday', () => {
            // Monday at 10:00 AM Eastern
            const context = {
                userAgent: '',
                country: 'US',
                lat: 0,
                lon: 0,
                timestamp: new Date('2026-01-26T15:00:00Z'), // 10 AM EST on Monday
            };
            const result = engine.traverse(context, timeTree);
            expect(result).toEqual(['var_business']);
        });
        it('should use default for weekend', () => {
            // Saturday at 10:00 AM Eastern
            const context = {
                userAgent: '',
                country: 'US',
                lat: 0,
                lon: 0,
                timestamp: new Date('2026-01-24T15:00:00Z'), // Saturday
            };
            const result = engine.traverse(context, timeTree);
            expect(result).toEqual(['var_afterhours']);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dyb3Zlci5oZWVyL0RvY3VtZW50cy9HaXRIdWIvQWR2aXRpeWFfSC9zcmMvX190ZXN0c19fL0RlY2lzaW9uVHJlZUVuZ2luZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsdUVBQXFGO0FBR3JGLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7SUFDaEMsSUFBSSxNQUEwQixDQUFDO0lBRS9CLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDWixNQUFNLEdBQUcsSUFBSSx1Q0FBa0IsRUFBRSxDQUFDO0lBQ3RDLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUU7UUFDekIsRUFBRSxDQUFDLGdDQUFnQyxFQUFFLEdBQUcsRUFBRTtZQUN0QyxNQUFNLFFBQVEsR0FBRyw2RUFBNkUsQ0FBQztZQUMvRixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGlDQUFpQyxFQUFFLEdBQUcsRUFBRTtZQUN2QyxNQUFNLFNBQVMsR0FBRywwRUFBMEUsQ0FBQztZQUM3RixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGdDQUFnQyxFQUFFLEdBQUcsRUFBRTtZQUN0QyxNQUFNLFFBQVEsR0FBRyxvRUFBb0UsQ0FBQztZQUN0RixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsSUFB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QyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDbEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQztRQUMvQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2dyb3Zlci5oZWVyL0RvY3VtZW50cy9HaXRIdWIvQWR2aXRpeWFfSC9zcmMvX190ZXN0c19fL0RlY2lzaW9uVHJlZUVuZ2luZS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERlY2lzaW9uVHJlZUVuZ2luZSwgSVJlcXVlc3RDb250ZXh0IH0gZnJvbSAnLi4vc2VydmljZXMvRGVjaXNpb25UcmVlRW5naW5lJztcbmltcG9ydCB7IElEZWNpc2lvbk5vZGUgfSBmcm9tICcuLi9tb2RlbHMvUnVsZVRyZWUnO1xuXG5kZXNjcmliZSgnRGVjaXNpb25UcmVlRW5naW5lJywgKCkgPT4ge1xuICAgIGxldCBlbmdpbmU6IERlY2lzaW9uVHJlZUVuZ2luZTtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICBlbmdpbmUgPSBuZXcgRGVjaXNpb25UcmVlRW5naW5lKCk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgncGFyc2VEZXZpY2UnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgaWRlbnRpZnkgbW9iaWxlIGRldmljZXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtb2JpbGVVQSA9ICdNb3ppbGxhLzUuMCAoaVBob25lOyBDUFUgaVBob25lIE9TIDE0XzAgbGlrZSBNYWMgT1MgWCkgQXBwbGVXZWJLaXQvNjA1LjEuMTUnO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZW5naW5lLnBhcnNlRGV2aWNlKG1vYmlsZVVBKTtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQudHlwZSkudG9CZSgnbW9iaWxlJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgaWRlbnRpZnkgZGVza3RvcCBkZXZpY2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGVza3RvcFVBID0gJ01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiBDaHJvbWUvOTEuMCc7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBlbmdpbmUucGFyc2VEZXZpY2UoZGVza3RvcFVBKTtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQudHlwZSkudG9CZSgnZGVza3RvcCcpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGlkZW50aWZ5IHRhYmxldCBkZXZpY2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGFibGV0VUEgPSAnTW96aWxsYS81LjAgKGlQYWQ7IENQVSBPUyAxNF8wIGxpa2UgTWFjIE9TIFgpIEFwcGxlV2ViS2l0LzYwNS4xLjE1JztcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGVuZ2luZS5wYXJzZURldmljZSh0YWJsZXRVQSk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LnR5cGUpLnRvQmUoJ3RhYmxldCcpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCd0cmF2ZXJzZScsICgpID0+IHtcbiAgICAgICAgY29uc3Qgc2FtcGxlVHJlZTogSURlY2lzaW9uTm9kZSA9IHtcbiAgICAgICAgICAgIHR5cGU6ICdkZXZpY2UnLFxuICAgICAgICAgICAgZGV2aWNlX2JyYW5jaGVzOiB7XG4gICAgICAgICAgICAgICAgbW9iaWxlOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdsb2NhdGlvbicsXG4gICAgICAgICAgICAgICAgICAgIGNvdW50cnlfYnJhbmNoZXM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFVTOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2xlYWYnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhbnRfaWRzOiBbJ3Zhcl91c19tb2JpbGUnXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBJTjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdsZWFmJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJpYW50X2lkczogWyd2YXJfaW5fbW9iaWxlJ10sXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbl9kZWZhdWx0X25vZGU6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdsZWFmJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhbnRfaWRzOiBbJ3Zhcl9nbG9iYWxfbW9iaWxlJ10sXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBkZXNrdG9wOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdsb2NhdGlvbicsXG4gICAgICAgICAgICAgICAgICAgIGNvdW50cnlfYnJhbmNoZXM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFVTOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2xlYWYnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhbnRfaWRzOiBbJ3Zhcl91c19kZXNrdG9wJ10sXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbl9kZWZhdWx0X25vZGU6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdsZWFmJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhbnRfaWRzOiBbJ3Zhcl9nbG9iYWxfZGVza3RvcCddLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnbGVhZicsXG4gICAgICAgICAgICAgICAgICAgIHZhcmlhbnRfaWRzOiBbJ3Zhcl9vdGhlciddLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmVzb2x2ZSBtb2JpbGUgKyBVUyBjb3JyZWN0bHknLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb250ZXh0OiBJUmVxdWVzdENvbnRleHQgPSB7XG4gICAgICAgICAgICAgICAgdXNlckFnZW50OiAnTW96aWxsYS81LjAgKGlQaG9uZTsgQ1BVIGlQaG9uZSBPUyAxNF8wIGxpa2UgTWFjIE9TIFgpJyxcbiAgICAgICAgICAgICAgICBjb3VudHJ5OiAnVVMnLFxuICAgICAgICAgICAgICAgIGxhdDogMCxcbiAgICAgICAgICAgICAgICBsb246IDAsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZW5naW5lLnRyYXZlcnNlKGNvbnRleHQsIHNhbXBsZVRyZWUpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChbJ3Zhcl91c19tb2JpbGUnXSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmVzb2x2ZSBtb2JpbGUgKyBJTiBjb3JyZWN0bHknLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb250ZXh0OiBJUmVxdWVzdENvbnRleHQgPSB7XG4gICAgICAgICAgICAgICAgdXNlckFnZW50OiAnTW96aWxsYS81LjAgKGlQaG9uZTsgQ1BVIGlQaG9uZSBPUyAxNF8wIGxpa2UgTWFjIE9TIFgpJyxcbiAgICAgICAgICAgICAgICBjb3VudHJ5OiAnSU4nLFxuICAgICAgICAgICAgICAgIGxhdDogMCxcbiAgICAgICAgICAgICAgICBsb246IDAsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZW5naW5lLnRyYXZlcnNlKGNvbnRleHQsIHNhbXBsZVRyZWUpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChbJ3Zhcl9pbl9tb2JpbGUnXSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmVzb2x2ZSBkZXNrdG9wICsgVVMgY29ycmVjdGx5JywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udGV4dDogSVJlcXVlc3RDb250ZXh0ID0ge1xuICAgICAgICAgICAgICAgIHVzZXJBZ2VudDogJ01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIENocm9tZS85MS4wJyxcbiAgICAgICAgICAgICAgICBjb3VudHJ5OiAnVVMnLFxuICAgICAgICAgICAgICAgIGxhdDogMCxcbiAgICAgICAgICAgICAgICBsb246IDAsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZW5naW5lLnRyYXZlcnNlKGNvbnRleHQsIHNhbXBsZVRyZWUpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChbJ3Zhcl91c19kZXNrdG9wJ10pO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGZhbGwgYmFjayB0byBnbG9iYWwgZm9yIHVua25vd24gY291bnRyeScsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRleHQ6IElSZXF1ZXN0Q29udGV4dCA9IHtcbiAgICAgICAgICAgICAgICB1c2VyQWdlbnQ6ICdNb3ppbGxhLzUuMCAoaVBob25lOyBDUFUgaVBob25lIE9TIDE0XzAgbGlrZSBNYWMgT1MgWCknLFxuICAgICAgICAgICAgICAgIGNvdW50cnk6ICdGUicsXG4gICAgICAgICAgICAgICAgbGF0OiAwLFxuICAgICAgICAgICAgICAgIGxvbjogMCxcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBlbmdpbmUudHJhdmVyc2UoY29udGV4dCwgc2FtcGxlVHJlZSk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKFsndmFyX2dsb2JhbF9tb2JpbGUnXSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgdXNlIGRlZmF1bHQgZGV2aWNlIGJyYW5jaCBmb3IgdW5rbm93biBkZXZpY2VzJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udGV4dDogSVJlcXVlc3RDb250ZXh0ID0ge1xuICAgICAgICAgICAgICAgIHVzZXJBZ2VudDogJ1NvbWVCb3QvMS4wJyxcbiAgICAgICAgICAgICAgICBjb3VudHJ5OiAnVVMnLFxuICAgICAgICAgICAgICAgIGxhdDogMCxcbiAgICAgICAgICAgICAgICBsb246IDAsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZW5naW5lLnRyYXZlcnNlKGNvbnRleHQsIHNhbXBsZVRyZWUpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChbJ3Zhcl9vdGhlciddKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgndGltZSB3aW5kb3cgZXZhbHVhdGlvbicsICgpID0+IHtcbiAgICAgICAgY29uc3QgdGltZVRyZWU6IElEZWNpc2lvbk5vZGUgPSB7XG4gICAgICAgICAgICB0eXBlOiAndGltZScsXG4gICAgICAgICAgICB0aW1lX3dpbmRvd3M6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGJyYW5jaF9pZDogJ2J1c2luZXNzX2hvdXJzJyxcbiAgICAgICAgICAgICAgICAgICAgcmVjdXJyaW5nOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXlzOiBbMSwgMiwgMywgNCwgNV0sIC8vIE1vbi1GcmlcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0X3RpbWU6ICcwOTowMCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmRfdGltZTogJzE3OjAwJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWV6b25lOiAnQW1lcmljYS9OZXdfWW9yaycsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIG5leHRfbm9kZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2xlYWYnLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFudF9pZHM6IFsndmFyX2J1c2luZXNzJ10sXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB0aW1lX2RlZmF1bHRfbm9kZToge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdsZWFmJyxcbiAgICAgICAgICAgICAgICB2YXJpYW50X2lkczogWyd2YXJfYWZ0ZXJob3VycyddLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfTtcblxuICAgICAgICBpdCgnc2hvdWxkIG1hdGNoIGJ1c2luZXNzIGhvdXJzIG9uIHdlZWtkYXknLCAoKSA9PiB7XG4gICAgICAgICAgICAvLyBNb25kYXkgYXQgMTA6MDAgQU0gRWFzdGVyblxuICAgICAgICAgICAgY29uc3QgY29udGV4dDogSVJlcXVlc3RDb250ZXh0ID0ge1xuICAgICAgICAgICAgICAgIHVzZXJBZ2VudDogJycsXG4gICAgICAgICAgICAgICAgY291bnRyeTogJ1VTJyxcbiAgICAgICAgICAgICAgICBsYXQ6IDAsXG4gICAgICAgICAgICAgICAgbG9uOiAwLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoJzIwMjYtMDEtMjZUMTU6MDA6MDBaJyksIC8vIDEwIEFNIEVTVCBvbiBNb25kYXlcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGVuZ2luZS50cmF2ZXJzZShjb250ZXh0LCB0aW1lVHJlZSk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKFsndmFyX2J1c2luZXNzJ10pO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHVzZSBkZWZhdWx0IGZvciB3ZWVrZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgLy8gU2F0dXJkYXkgYXQgMTA6MDAgQU0gRWFzdGVyblxuICAgICAgICAgICAgY29uc3QgY29udGV4dDogSVJlcXVlc3RDb250ZXh0ID0ge1xuICAgICAgICAgICAgICAgIHVzZXJBZ2VudDogJycsXG4gICAgICAgICAgICAgICAgY291bnRyeTogJ1VTJyxcbiAgICAgICAgICAgICAgICBsYXQ6IDAsXG4gICAgICAgICAgICAgICAgbG9uOiAwLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoJzIwMjYtMDEtMjRUMTU6MDA6MDBaJyksIC8vIFNhdHVyZGF5XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBlbmdpbmUudHJhdmVyc2UoY29udGV4dCwgdGltZVRyZWUpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChbJ3Zhcl9hZnRlcmhvdXJzJ10pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9