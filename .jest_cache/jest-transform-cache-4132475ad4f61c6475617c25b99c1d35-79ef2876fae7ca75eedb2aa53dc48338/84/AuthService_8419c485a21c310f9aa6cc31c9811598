f9b3f6f9641b4742adac950ac208c336
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.authService = exports.AuthService = void 0;
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const uuid_1 = require("uuid");
const User_1 = require("../models/User");
const JWT_SECRET = process.env.JWT_SECRET || 'smart-link-hub-secret-change-in-production';
const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '7d';
/**
 * Authentication Service
 * Handles user registration, login, and JWT token management
 */
class AuthService {
    /**
     * Register a new user
     */
    async register(email, password, name, role) {
        // Check if email already exists
        const existing = await User_1.User.findOne({ email: email.toLowerCase() });
        if (existing) {
            throw new Error('Email already registered');
        }
        // Validate password strength
        if (password.length < 8) {
            throw new Error('Password must be at least 8 characters');
        }
        // Hash password
        const password_hash = await (0, User_1.hashPassword)(password);
        // Create user
        const user = await User_1.User.create({
            user_id: (0, uuid_1.v4)(),
            email: email.toLowerCase(),
            password_hash,
            name,
            role: role || 'user',
        });
        // Generate token
        const token = this.generateToken(user);
        return {
            user: {
                user_id: user.user_id,
                email: user.email,
                name: user.name,
                role: user.role,
            },
            token,
            expires_in: JWT_EXPIRES_IN,
        };
    }
    /**
     * Login with email and password
     */
    async login(email, password) {
        // Find user with password
        const user = await User_1.User.findOne({ email: email.toLowerCase() })
            .select('+password_hash');
        if (!user) {
            throw new Error('Invalid email or password');
        }
        // Compare passwords
        const isMatch = await user.comparePassword(password);
        if (!isMatch) {
            throw new Error('Invalid email or password');
        }
        // Generate token
        const token = this.generateToken(user);
        return {
            user: {
                user_id: user.user_id,
                email: user.email,
                name: user.name,
                role: user.role,
            },
            token,
            expires_in: JWT_EXPIRES_IN,
        };
    }
    /**
     * Verify a JWT token and return the payload
     */
    verifyToken(token) {
        try {
            const payload = jsonwebtoken_1.default.verify(token, JWT_SECRET);
            return payload;
        }
        catch (error) {
            throw new Error('Invalid or expired token');
        }
    }
    /**
     * Generate a JWT token for a user
     */
    generateToken(user) {
        const payload = {
            user_id: user.user_id,
            email: user.email,
            role: user.role,
        };
        // Convert expiry to seconds (7 days default)
        const expiresInSeconds = this.parseExpiryToSeconds(JWT_EXPIRES_IN);
        return jsonwebtoken_1.default.sign(payload, JWT_SECRET, {
            expiresIn: expiresInSeconds,
        });
    }
    /**
     * Parse expiry string to seconds
     */
    parseExpiryToSeconds(expiry) {
        const match = expiry.match(/^(\d+)([smhd])$/);
        if (!match) {
            return 7 * 24 * 60 * 60; // Default: 7 days
        }
        const value = parseInt(match[1], 10);
        const unit = match[2];
        switch (unit) {
            case 's': return value;
            case 'm': return value * 60;
            case 'h': return value * 60 * 60;
            case 'd': return value * 24 * 60 * 60;
            default: return 7 * 24 * 60 * 60;
        }
    }
    /**
     * Get user by ID
     */
    async getUserById(userId) {
        return User_1.User.findOne({ user_id: userId });
    }
    /**
     * Get user by email
     */
    async getUserByEmail(email) {
        return User_1.User.findOne({ email: email.toLowerCase() });
    }
    /**
     * Check if a user is admin
     */
    isAdmin(user) {
        return user.role === 'admin';
    }
}
exports.AuthService = AuthService;
// Singleton instance
exports.authService = new AuthService();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dyb3Zlci5oZWVyL0RvY3VtZW50cy9HaXRIdWIvQWR2aXRpeWFfSC9zcmMvc2VydmljZXMvQXV0aFNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsZ0VBQStCO0FBQy9CLCtCQUFvQztBQUNwQyx5Q0FBcUU7QUFFckUsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksNENBQTRDLENBQUM7QUFDMUYsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDO0FBeUIxRDs7O0dBR0c7QUFDSCxNQUFhLFdBQVc7SUFFcEI7O09BRUc7SUFDSCxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQWEsRUFBRSxRQUFnQixFQUFFLElBQWEsRUFBRSxJQUFlO1FBQzFFLGdDQUFnQztRQUNoQyxNQUFNLFFBQVEsR0FBRyxNQUFNLFdBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNwRSxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBQ2hELENBQUM7UUFFRCw2QkFBNkI7UUFDN0IsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMsd0NBQXdDLENBQUMsQ0FBQztRQUM5RCxDQUFDO1FBRUQsZ0JBQWdCO1FBQ2hCLE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBQSxtQkFBWSxFQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRW5ELGNBQWM7UUFDZCxNQUFNLElBQUksR0FBRyxNQUFNLFdBQUksQ0FBQyxNQUFNLENBQUM7WUFDM0IsT0FBTyxFQUFFLElBQUEsU0FBTSxHQUFFO1lBQ2pCLEtBQUssRUFBRSxLQUFLLENBQUMsV0FBVyxFQUFFO1lBQzFCLGFBQWE7WUFDYixJQUFJO1lBQ0osSUFBSSxFQUFFLElBQUks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QUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDckMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLFFBQVEsSUFBSSxFQUFFLENBQUM7WUFDWCxLQUFLLEdBQUcsQ0FBQyxDQUFDLE9BQU8sS0FBSyxDQUFDO1lBQ3ZCLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBTyxLQUFLLEdBQUcsRUFBRSxDQUFDO1lBQzVCLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBTyxLQUFLLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUNqQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLE9BQU8sS0FBSyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDO1lBQ3RDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ3JDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQWM7UUFDNUIsT0FBTyxXQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGNBQWMsQ0FBQyxLQUFhO1FBQzlCLE9BQU8sV0FBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFRDs7T0FFRztJQUNILE9BQU8sQ0FBQyxJQUF5QjtRQUM3QixPQUFPLElBQUksQ0FBQyxJQUFJLEtBQUssT0FBTyxDQUFDO0lBQ2pDLENBQUM7Q0FDSjtBQWxKRCxrQ0FrSkM7QUFFRCxxQkFBcUI7QUFDUixRQUFBLFdBQVcsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9ncm92ZXIuaGVlci9Eb2N1bWVudHMvR2l0SHViL0Fkdml0aXlhX0gvc3JjL3NlcnZpY2VzL0F1dGhTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuaW1wb3J0IHsgVXNlciwgSVVzZXIsIGhhc2hQYXNzd29yZCwgVXNlclJvbGUgfSBmcm9tICcuLi9tb2RlbHMvVXNlcic7XG5cbmNvbnN0IEpXVF9TRUNSRVQgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUIHx8ICdzbWFydC1saW5rLWh1Yi1zZWNyZXQtY2hhbmdlLWluLXByb2R1Y3Rpb24nO1xuY29uc3QgSldUX0VYUElSRVNfSU4gPSBwcm9jZXNzLmVudi5KV1RfRVhQSVJFU19JTiB8fCAnN2QnO1xuXG4vKipcbiAqIEpXVCBQYXlsb2FkIHN0cnVjdHVyZVxuICovXG5leHBvcnQgaW50ZXJmYWNlIElKV1RQYXlsb2FkIHtcbiAgICB1c2VyX2lkOiBzdHJpbmc7XG4gICAgZW1haWw6IHN0cmluZztcbiAgICByb2xlOiBVc2VyUm9sZTtcbn1cblxuLyoqXG4gKiBBdXRoIHJlc3VsdCByZXR1cm5lZCBhZnRlciBzdWNjZXNzZnVsIGxvZ2luL3JlZ2lzdGVyXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUF1dGhSZXN1bHQge1xuICAgIHVzZXI6IHtcbiAgICAgICAgdXNlcl9pZDogc3RyaW5nO1xuICAgICAgICBlbWFpbDogc3RyaW5nO1xuICAgICAgICBuYW1lPzogc3RyaW5nO1xuICAgICAgICByb2xlOiBVc2VyUm9sZTtcbiAgICB9O1xuICAgIHRva2VuOiBzdHJpbmc7XG4gICAgZXhwaXJlc19pbjogc3RyaW5nO1xufVxuXG4vKipcbiAqIEF1dGhlbnRpY2F0aW9uIFNlcnZpY2VcbiAqIEhhbmRsZXMgdXNlciByZWdpc3RyYXRpb24sIGxvZ2luLCBhbmQgSldUIHRva2VuIG1hbmFnZW1lbnRcbiAqL1xuZXhwb3J0IGNsYXNzIEF1dGhTZXJ2aWNlIHtcblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyIGEgbmV3IHVzZXJcbiAgICAgKi9cbiAgICBhc3luYyByZWdpc3RlcihlbWFpbDogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCBuYW1lPzogc3RyaW5nLCByb2xlPzogVXNlclJvbGUpOiBQcm9taXNlPElBdXRoUmVzdWx0PiB7XG4gICAgICAgIC8vIENoZWNrIGlmIGVtYWlsIGFscmVhZHkgZXhpc3RzXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgVXNlci5maW5kT25lKHsgZW1haWw6IGVtYWlsLnRvTG93ZXJDYXNlKCkgfSk7XG4gICAgICAgIGlmIChleGlzdGluZykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbWFpbCBhbHJlYWR5IHJlZ2lzdGVyZWQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZhbGlkYXRlIHBhc3N3b3JkIHN0cmVuZ3RoXG4gICAgICAgIGlmIChwYXNzd29yZC5sZW5ndGggPCA4KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bhc3N3b3JkIG11c3QgYmUgYXQgbGVhc3QgOCBjaGFyYWN0ZXJzJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBIYXNoIHBhc3N3b3JkXG4gICAgICAgIGNvbnN0IHBhc3N3b3JkX2hhc2ggPSBhd2FpdCBoYXNoUGFzc3dvcmQocGFzc3dvcmQpO1xuXG4gICAgICAgIC8vIENyZWF0ZSB1c2VyXG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmNyZWF0ZSh7XG4gICAgICAgICAgICB1c2VyX2lkOiB1dWlkdjQoKSxcbiAgICAgICAgICAgIGVtYWlsOiBlbWFpbC50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgcGFzc3dvcmRfaGFzaCxcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICByb2xlOiByb2xlIHx8ICd1c2VyJyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gR2VuZXJhdGUgdG9rZW5cbiAgICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLmdlbmVyYXRlVG9rZW4odXNlcik7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICB1c2VyX2lkOiB1c2VyLnVzZXJfaWQsXG4gICAgICAgICAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICAgICAgICAgICAgbmFtZTogdXNlci5uYW1lLFxuICAgICAgICAgICAgICAgIHJvbGU6IHVzZXIucm9sZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0b2tlbixcbiAgICAgICAgICAgIGV4cGlyZXNfaW46IEpXVF9FWFBJUkVTX0lOLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvZ2luIHdpdGggZW1haWwgYW5kIHBhc3N3b3JkXG4gICAgICovXG4gICAgYXN5bmMgbG9naW4oZW1haWw6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZyk6IFByb21pc2U8SUF1dGhSZXN1bHQ+IHtcbiAgICAgICAgLy8gRmluZCB1c2VyIHdpdGggcGFzc3dvcmRcbiAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IGVtYWlsOiBlbWFpbC50b0xvd2VyQ2FzZSgpIH0pXG4gICAgICAgICAgICAuc2VsZWN0KCcrcGFzc3dvcmRfaGFzaCcpO1xuXG4gICAgICAgIGlmICghdXNlcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGVtYWlsIG9yIHBhc3N3b3JkJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDb21wYXJlIHBhc3N3b3Jkc1xuICAgICAgICBjb25zdCBpc01hdGNoID0gYXdhaXQgdXNlci5jb21wYXJlUGFzc3dvcmQocGFzc3dvcmQpO1xuICAgICAgICBpZiAoIWlzTWF0Y2gpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBlbWFpbCBvciBwYXNzd29yZCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR2VuZXJhdGUgdG9rZW5cbiAgICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLmdlbmVyYXRlVG9rZW4odXNlcik7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICB1c2VyX2lkOiB1c2VyLnVzZXJfaWQsXG4gICAgICAgICAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICAgICAgICAgICAgbmFtZTogdXNlci5uYW1lLFxuICAgICAgICAgICAgICAgIHJvbGU6IHVzZXIucm9sZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0b2tlbixcbiAgICAgICAgICAgIGV4cGlyZXNfaW46IEpXVF9FWFBJUkVTX0lOLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFZlcmlmeSBhIEpXVCB0b2tlbiBhbmQgcmV0dXJuIHRoZSBwYXlsb2FkXG4gICAgICovXG4gICAgdmVyaWZ5VG9rZW4odG9rZW46IHN0cmluZyk6IElKV1RQYXlsb2FkIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSBqd3QudmVyaWZ5KHRva2VuLCBKV1RfU0VDUkVUKSBhcyBJSldUUGF5bG9hZDtcbiAgICAgICAgICAgIHJldHVybiBwYXlsb2FkO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIG9yIGV4cGlyZWQgdG9rZW4nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdlbmVyYXRlIGEgSldUIHRva2VuIGZvciBhIHVzZXJcbiAgICAgKi9cbiAgICBwcml2YXRlIGdlbmVyYXRlVG9rZW4odXNlcjogSVVzZXIpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBwYXlsb2FkOiBJSldUUGF5bG9hZCA9IHtcbiAgICAgICAgICAgIHVzZXJfaWQ6IHVzZXIudXNlcl9pZCxcbiAgICAgICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICAgICAgcm9sZTogdXNlci5yb2xlLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIENvbnZlcnQgZXhwaXJ5IHRvIHNlY29uZHMgKDcgZGF5cyBkZWZhdWx0KVxuICAgICAgICBjb25zdCBleHBpcmVzSW5TZWNvbmRzID0gdGhpcy5wYXJzZUV4cGlyeVRvU2Vjb25kcyhKV1RfRVhQSVJFU19JTik7XG5cbiAgICAgICAgcmV0dXJuIGp3dC5zaWduKHBheWxvYWQsIEpXVF9TRUNSRVQsIHtcbiAgICAgICAgICAgIGV4cGlyZXNJbjogZXhwaXJlc0luU2Vjb25kcyxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFyc2UgZXhwaXJ5IHN0cmluZyB0byBzZWNvbmRzXG4gICAgICovXG4gICAgcHJpdmF0ZSBwYXJzZUV4cGlyeVRvU2Vjb25kcyhleHBpcnk6IHN0cmluZyk6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IG1hdGNoID0gZXhwaXJ5Lm1hdGNoKC9eKFxcZCspKFtzbWhkXSkkLyk7XG4gICAgICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgICAgIHJldHVybiA3ICogMjQgKiA2MCAqIDYwOyAvLyBEZWZhdWx0OiA3IGRheXNcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB2YWx1ZSA9IHBhcnNlSW50KG1hdGNoWzFdLCAxMCk7XG4gICAgICAgIGNvbnN0IHVuaXQgPSBtYXRjaFsyXTtcbiAgICAgICAgc3dpdGNoICh1bml0KSB7XG4gICAgICAgICAgICBjYXNlICdzJzogcmV0dXJuIHZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnbSc6IHJldHVybiB2YWx1ZSAqIDYwO1xuICAgICAgICAgICAgY2FzZSAnaCc6IHJldHVybiB2YWx1ZSAqIDYwICogNjA7XG4gICAgICAgICAgICBjYXNlICdkJzogcmV0dXJuIHZhbHVlICogMjQgKiA2MCAqIDYwO1xuICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIDcgKiAyNCAqIDYwICogNjA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdXNlciBieSBJRFxuICAgICAqL1xuICAgIGFzeW5jIGdldFVzZXJCeUlkKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxJVXNlciB8IG51bGw+IHtcbiAgICAgICAgcmV0dXJuIFVzZXIuZmluZE9uZSh7IHVzZXJfaWQ6IHVzZXJJZCB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdXNlciBieSBlbWFpbFxuICAgICAqL1xuICAgIGFzeW5jIGdldFVzZXJCeUVtYWlsKGVtYWlsOiBzdHJpbmcpOiBQcm9taXNlPElVc2VyIHwgbnVsbD4ge1xuICAgICAgICByZXR1cm4gVXNlci5maW5kT25lKHsgZW1haWw6IGVtYWlsLnRvTG93ZXJDYXNlKCkgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgYSB1c2VyIGlzIGFkbWluXG4gICAgICovXG4gICAgaXNBZG1pbih1c2VyOiBJVXNlciB8IElKV1RQYXlsb2FkKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB1c2VyLnJvbGUgPT09ICdhZG1pbic7XG4gICAgfVxufVxuXG4vLyBTaW5nbGV0b24gaW5zdGFuY2VcbmV4cG9ydCBjb25zdCBhdXRoU2VydmljZSA9IG5ldyBBdXRoU2VydmljZSgpO1xuIl0sInZlcnNpb24iOjN9