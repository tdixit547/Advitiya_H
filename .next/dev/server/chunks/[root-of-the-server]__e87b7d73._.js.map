{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 48, "column": 0}, "map": {"version":3,"sources":["file:///Users/grover.heer/Documents/GitHub/Advitiya_H/src/lib/db.ts"],"sourcesContent":["// ============================================\n// SMART LINK HUB - Database Connection\n// ============================================\n\nimport { Pool, QueryResultRow } from 'pg';\n\n// Create a connection pool\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n});\n\n/**\n * Execute a SQL query.\n */\nexport async function query<T extends QueryResultRow>(\n  text: string,\n  params?: (string | number | boolean | null)[]\n) {\n  const start = Date.now();\n  try {\n    const result = await pool.query<T>(text, params);\n    const duration = Date.now() - start;\n    if (process.env.NODE_ENV === 'development') {\n      console.log('Executed query', { text: text.substring(0, 50), duration, rows: result.rowCount });\n    }\n    return result;\n  } catch (error) {\n    console.error('Database query error:', error);\n    throw error;\n  }\n}\n\n/**\n * Get a single row by query.\n */\nexport async function queryOne<T extends QueryResultRow>(\n  text: string,\n  params?: (string | number | boolean | null)[]\n): Promise<T | null> {\n  const result = await query<T>(text, params);\n  return result.rows[0] || null;\n}\n\n/**\n * Get multiple rows by query.\n */\nexport async function queryMany<T extends QueryResultRow>(\n  text: string,\n  params?: (string | number | boolean | null)[]\n): Promise<T[]> {\n  const result = await query<T>(text, params);\n  return result.rows;\n}\n\n/**\n * Execute an INSERT and return the inserted row.\n */\nexport async function insertOne<T extends QueryResultRow>(\n  text: string,\n  params?: (string | number | boolean | null)[]\n): Promise<T> {\n  const result = await query<T>(text, params);\n  return result.rows[0];\n}\n\n/**\n * Health check for database connection.\n */\nexport async function checkConnection(): Promise<boolean> {\n  try {\n    await pool.query('SELECT 1');\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nexport default pool;\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA,+CAA+C;AAC/C,uCAAuC;AACvC,+CAA+C;AAE/C;;;;;;AAEA,2BAA2B;AAC3B,MAAM,OAAO,IAAI,0LAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;IAC7E,KAAK;IACL,mBAAmB;IACnB,yBAAyB;AAC3B;AAKO,eAAe,MACpB,IAAY,EACZ,MAA6C;IAE7C,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,SAAS,MAAM,KAAK,KAAK,CAAI,MAAM;QACzC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,wCAA4C;YAC1C,QAAQ,GAAG,CAAC,kBAAkB;gBAAE,MAAM,KAAK,SAAS,CAAC,GAAG;gBAAK;gBAAU,MAAM,OAAO,QAAQ;YAAC;QAC/F;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM;IACR;AACF;AAKO,eAAe,SACpB,IAAY,EACZ,MAA6C;IAE7C,MAAM,SAAS,MAAM,MAAS,MAAM;IACpC,OAAO,OAAO,IAAI,CAAC,EAAE,IAAI;AAC3B;AAKO,eAAe,UACpB,IAAY,EACZ,MAA6C;IAE7C,MAAM,SAAS,MAAM,MAAS,MAAM;IACpC,OAAO,OAAO,IAAI;AACpB;AAKO,eAAe,UACpB,IAAY,EACZ,MAA6C;IAE7C,MAAM,SAAS,MAAM,MAAS,MAAM;IACpC,OAAO,OAAO,IAAI,CAAC,EAAE;AACvB;AAKO,eAAe;IACpB,IAAI;QACF,MAAM,KAAK,KAAK,CAAC;QACjB,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF;uCAEe"}},
    {"offset": {"line": 125, "column": 0}, "map": {"version":3,"sources":["file:///Users/grover.heer/Documents/GitHub/Advitiya_H/src/app/api/analytics/stats/route.ts"],"sourcesContent":["// ============================================\n// SMART LINK HUB - Analytics Stats API\n// GET /api/analytics/stats - PostgreSQL version\n// ============================================\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { AnalyticsStats } from '@/types';\nimport { queryMany, queryOne } from '@/lib/db';\n\ninterface TopLinkRow {\n  id: number;\n  title: string;\n  clicks: number;\n  ctr: number;\n}\n\ninterface ViewsByDayRow {\n  date: string;\n  views: number;\n  clicks: number;\n}\n\ninterface ViewsByCountryRow {\n  country: string;\n  count: number;\n}\n\ninterface ViewsByDeviceRow {\n  device: string;\n  count: number;\n}\n\ninterface TotalsRow {\n  total_views: number;\n  total_clicks: number;\n  unique_visitors: number;\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const hubId = searchParams.get('hub_id');\n    const period = searchParams.get('period') || '7d';\n\n    // Calculate date range\n    let days = 7;\n    if (period === '30d') days = 30;\n    if (period === '90d') days = 90;\n\n    const hubIdNum = hubId ? parseInt(hubId) : 1;\n\n    // Get totals\n    const totals = await queryOne<TotalsRow>(\n      `SELECT \n        COUNT(*) FILTER (WHERE event_type = 'VIEW') as total_views,\n        COUNT(*) FILTER (WHERE event_type = 'CLICK') as total_clicks,\n        COUNT(DISTINCT visitor_ip) as unique_visitors\n       FROM events \n       WHERE hub_id = $1 \n       AND created_at >= NOW() - INTERVAL '${days} days'`,\n      [hubIdNum]\n    );\n\n    // Get top links\n    const topLinks = await queryMany<TopLinkRow>(\n      `SELECT \n        l.id,\n        l.title,\n        COUNT(e.id) FILTER (WHERE e.event_type = 'CLICK') as clicks,\n        CASE \n          WHEN COUNT(e.id) FILTER (WHERE e.event_type = 'VIEW') > 0 \n          THEN ROUND(\n            COUNT(e.id) FILTER (WHERE e.event_type = 'CLICK')::numeric / \n            COUNT(e.id) FILTER (WHERE e.event_type = 'VIEW')::numeric * 100, 1\n          )\n          ELSE 0\n        END as ctr\n       FROM links l\n       LEFT JOIN events e ON e.link_id = l.id AND e.created_at >= NOW() - INTERVAL '${days} days'\n       WHERE l.hub_id = $1\n       GROUP BY l.id, l.title\n       ORDER BY clicks DESC\n       LIMIT 5`,\n      [hubIdNum]\n    );\n\n    // Get views by day\n    const viewsByDay = await queryMany<ViewsByDayRow>(\n      `SELECT \n        DATE(created_at) as date,\n        COUNT(*) FILTER (WHERE event_type = 'VIEW') as views,\n        COUNT(*) FILTER (WHERE event_type = 'CLICK') as clicks\n       FROM events\n       WHERE hub_id = $1 AND created_at >= NOW() - INTERVAL '${days} days'\n       GROUP BY DATE(created_at)\n       ORDER BY date`,\n      [hubIdNum]\n    );\n\n    // Get views by country\n    const viewsByCountry = await queryMany<ViewsByCountryRow>(\n      `SELECT \n        COALESCE(visitor_country, 'Unknown') as country,\n        COUNT(*) as count\n       FROM events\n       WHERE hub_id = $1 AND created_at >= NOW() - INTERVAL '${days} days'\n       GROUP BY visitor_country\n       ORDER BY count DESC\n       LIMIT 10`,\n      [hubIdNum]\n    );\n\n    // Get views by device\n    const viewsByDevice = await queryMany<ViewsByDeviceRow>(\n      `SELECT \n        COALESCE(visitor_device, 'unknown') as device,\n        COUNT(*) as count\n       FROM events\n       WHERE hub_id = $1 AND created_at >= NOW() - INTERVAL '${days} days'\n       GROUP BY visitor_device\n       ORDER BY count DESC`,\n      [hubIdNum]\n    );\n\n    const stats: AnalyticsStats = {\n      totalViews: Number(totals?.total_views || 0),\n      totalClicks: Number(totals?.total_clicks || 0),\n      uniqueVisitors: Number(totals?.unique_visitors || 0),\n      topLinks: topLinks.map(l => ({\n        id: l.id,\n        title: l.title,\n        clicks: Number(l.clicks),\n        ctr: Number(l.ctr),\n      })),\n      viewsByDay: viewsByDay.map(v => ({\n        date: String(v.date),\n        views: Number(v.views),\n        clicks: Number(v.clicks),\n      })),\n      viewsByCountry: viewsByCountry.map(v => ({\n        country: v.country,\n        count: Number(v.count),\n      })),\n      viewsByDevice: viewsByDevice.map(v => ({\n        device: v.device,\n        count: Number(v.count),\n      })),\n    };\n\n    return NextResponse.json({\n      success: true,\n      data: stats,\n    });\n  } catch (error) {\n    console.error('[Analytics] Error fetching stats:', error);\n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch analytics' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA,+CAA+C;AAC/C,uCAAuC;AACvC,gDAAgD;AAChD,+CAA+C;AAE/C;AAEA;;;;;;;AA+BO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,QAAQ,aAAa,GAAG,CAAC;QAC/B,MAAM,SAAS,aAAa,GAAG,CAAC,aAAa;QAE7C,uBAAuB;QACvB,IAAI,OAAO;QACX,IAAI,WAAW,OAAO,OAAO;QAC7B,IAAI,WAAW,OAAO,OAAO;QAE7B,MAAM,WAAW,QAAQ,SAAS,SAAS;QAE3C,aAAa;QACb,MAAM,SAAS,MAAM,IAAA,mKAAQ,EAC3B,CAAC;;;;;;2CAMoC,EAAE,KAAK,MAAM,CAAC,EACnD;YAAC;SAAS;QAGZ,gBAAgB;QAChB,MAAM,WAAW,MAAM,IAAA,oKAAS,EAC9B,CAAC;;;;;;;;;;;;;oFAa6E,EAAE,KAAK;;;;cAI7E,CAAC,EACT;YAAC;SAAS;QAGZ,mBAAmB;QACnB,MAAM,aAAa,MAAM,IAAA,oKAAS,EAChC,CAAC;;;;;6DAKsD,EAAE,KAAK;;oBAEhD,CAAC,EACf;YAAC;SAAS;QAGZ,uBAAuB;QACvB,MAAM,iBAAiB,MAAM,IAAA,oKAAS,EACpC,CAAC;;;;6DAIsD,EAAE,KAAK;;;eAGrD,CAAC,EACV;YAAC;SAAS;QAGZ,sBAAsB;QACtB,MAAM,gBAAgB,MAAM,IAAA,oKAAS,EACnC,CAAC;;;;6DAIsD,EAAE,KAAK;;0BAE1C,CAAC,EACrB;YAAC;SAAS;QAGZ,MAAM,QAAwB;YAC5B,YAAY,OAAO,QAAQ,eAAe;YAC1C,aAAa,OAAO,QAAQ,gBAAgB;YAC5C,gBAAgB,OAAO,QAAQ,mBAAmB;YAClD,UAAU,SAAS,GAAG,CAAC,CAAA,IAAK,CAAC;oBAC3B,IAAI,EAAE,EAAE;oBACR,OAAO,EAAE,KAAK;oBACd,QAAQ,OAAO,EAAE,MAAM;oBACvB,KAAK,OAAO,EAAE,GAAG;gBACnB,CAAC;YACD,YAAY,WAAW,GAAG,CAAC,CAAA,IAAK,CAAC;oBAC/B,MAAM,OAAO,EAAE,IAAI;oBACnB,OAAO,OAAO,EAAE,KAAK;oBACrB,QAAQ,OAAO,EAAE,MAAM;gBACzB,CAAC;YACD,gBAAgB,eAAe,GAAG,CAAC,CAAA,IAAK,CAAC;oBACvC,SAAS,EAAE,OAAO;oBAClB,OAAO,OAAO,EAAE,KAAK;gBACvB,CAAC;YACD,eAAe,cAAc,GAAG,CAAC,CAAA,IAAK,CAAC;oBACrC,QAAQ,EAAE,MAAM;oBAChB,OAAO,OAAO,EAAE,KAAK;gBACvB,CAAC;QACH;QAEA,OAAO,qLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;QACR;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO,qLAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAA4B,GACrD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}